<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Coparmex</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        .ui-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.9);
            padding: 20px;
        }
        .hidden {
            display: none !important;
        }
        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            margin: 10px;
            font-size: 18px;
            cursor: pointer;
            color: white;
            background-color: #4CAF50;
        }
        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 10;
            max-width: 80%;
            text-align: center;
        }
        .debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 100;
            max-height: 30%;
            overflow-y: auto;
        }
        .debug-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .error-log {
            color: #ff5555;
        }
        .info-log {
            color: #55ff55;
        }
        .action-button {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            color: white;
            background-color: #4CAF50;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="startScreen" class="ui-container">
        <h1>Experiencia Coparmex</h1>
        <p>Esta experiencia AR te permite ver un modelo 3D del stand de Coparmex CDMX.</p>
        <button id="startButton" class="button">Iniciar Experiencia AR</button>
    </div>

    <!-- AR Status -->
    <div id="statusMessage" class="status-message hidden">Buscando superficies...</div>

    <!-- Action Button (for placing model) -->
    <button id="actionButton" class="action-button hidden">Colocar Modelo Aquí</button>

    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel hidden">
        <div class="debug-title">Diagnostico AR:</div>
        <div id="debugLog"></div>
    </div>

    <!-- AR Scene -->
    <a-scene 
        id="arScene"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true;"
        embedded
        style="display: none;">
        
        <a-assets>
            <a-asset-item id="stand-model" src="stand-1.glb"></a-asset-item>
        </a-assets>

        <a-entity id="camera" camera position="0 1.6 0"></a-entity>
        
        <a-entity 
            id="stand-model"
            gltf-model="#stand-model"
            position="0 0 -5"
            scale="1 1 1"
            rotation="0 0 0"
            visible="false">
        </a-entity>
    </a-scene>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const startScreen = document.getElementById('startScreen');
            const startButton = document.getElementById('startButton');
            const arScene = document.getElementById('arScene');
            const statusMessage = document.getElementById('statusMessage');
            const standModel = document.getElementById('stand-model');
            const debugPanel = document.getElementById('debugPanel');
            const debugLog = document.getElementById('debugLog');
            const actionButton = document.getElementById('actionButton');
            
            // State
            let xrSession = null;
            let hitTestStartTime = 0;
            let lastHitTestTime = 0;
            let hitTestCount = 0;
            let frameCount = 0;
            let usingFallbackPlacement = false;
            
            // Debug logging
            function logDebug(message, isError = false) {
                const now = new Date();
                const timestamp = now.toLocaleTimeString();
                const logClass = isError ? 'error-log' : 'info-log';
                
                debugLog.innerHTML += `<div class="${logClass}">[${timestamp}] ${message}</div>`;
                debugPanel.scrollTop = debugPanel.scrollHeight;
                
                if (isError) {
                    console.error(message);
                } else {
                    console.log(message);
                }
            }
            
            // Check device info
            function getDeviceInfo() {
                const ua = navigator.userAgent;
                const browserInfo = ua.match(/(chrome|firefox|safari|edge|opera)\/?\s*(\.?\d+(\.\d+)*)/i);
                const browser = browserInfo ? browserInfo[1] : "unknown";
                const browserVersion = browserInfo ? browserInfo[2] : "unknown";
                
                const deviceInfo = {
                    userAgent: ua,
                    browser: browser,
                    browserVersion: browserVersion,
                    mobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua),
                    ios: /iPad|iPhone|iPod/.test(ua),
                    android: /Android/.test(ua),
                    webXRSupported: !!navigator.xr
                };
                
                return deviceInfo;
            }
            
            // Start AR experience
            function startAR() {
                startScreen.classList.add('hidden');
                arScene.style.display = 'block';
                statusMessage.classList.remove('hidden');
                debugPanel.classList.remove('hidden');
                
                const deviceInfo = getDeviceInfo();
                logDebug(`Dispositivo: ${deviceInfo.mobile ? 'Móvil' : 'Desktop'} - ${deviceInfo.browser} ${deviceInfo.browserVersion}`);
                logDebug(`Sistema: ${deviceInfo.ios ? 'iOS' : deviceInfo.android ? 'Android' : 'Otro'}`);
                
                // For Android Chrome (which has known hit-test issues)
                const isAndroidChrome = deviceInfo.android && deviceInfo.browser.toLowerCase() === 'chrome';
                if (isAndroidChrome) {
                    logDebug("Detected Android Chrome - may have hit-test limitations", true);
                }
                
                if (navigator.xr) {
                    logDebug("WebXR API disponible");

                    navigator.xr.isSessionSupported('immersive-ar')
                        .then(supported => {
                            if (!supported) {
                                logDebug("AR no soportado en este dispositivo", true);
                                showFallbackModel('AR no soportado en este dispositivo');
                                return;
                            }
                            
                            logDebug("AR soportado, solicitando sesión");
                            
                            // For Android, try without requiring hit-test
                            const sessionInit = isAndroidChrome ? 
                                {
                                    optionalFeatures: ['hit-test', 'dom-overlay'],
                                    domOverlay: { root: document.body }
                                } : 
                                {
                                    requiredFeatures: ['hit-test'],
                                    optionalFeatures: ['dom-overlay'],
                                    domOverlay: { root: document.body }
                                };
                            
                            navigator.xr.requestSession('immersive-ar', sessionInit)
                                .then(session => {
                                    xrSession = session;
                                    logDebug("Sesión AR iniciada correctamente");
                                    
                                    // Handle session end
                                    session.addEventListener('end', onSessionEnd);
                                    
                                    // Use A-Frame's built-in WebXR integration
                                    try {
                                        arScene.renderer.xr.setReferenceSpaceType('local');
                                        arScene.renderer.xr.setSession(session);
                                        logDebug("A-Frame XR configurado");
                                    } catch (err) {
                                        logDebug(`Error al configurar A-Frame XR: ${err.message}`, true);
                                        showFallbackModel('Error de inicialización');
                                        return;
                                    }
                                    
                                    // Enable manual placement after 5 seconds if hit test is not working
                                    setTimeout(() => {
                                        if (hitTestCount === 0 && !standModel.getAttribute('visible')) {
                                            setupManualPlacement();
                                        }
                                    }, 5000);
                                    
                                    session.requestReferenceSpace('local')
                                        .then(refSpace => {
                                            logDebug("Reference space obtenido: local");
                                            
                                            // Try different hit test types
                                            const hitTestOptions = [
                                                { space: refSpace }, // Default
                                                { space: refSpace, entityTypes: ['plane'] }, // Specific for planes
                                                { space: refSpace, entityTypes: ['mesh'] }, // Specific for meshes
                                                { space: refSpace, offsetRay: new XRRay(new DOMPoint(0, 0, 0, 1), new DOMPoint(0, 0, -1, 0)) } // Forward ray
                                            ];
                                            
                                            // Try first hit test method
                                            session.requestHitTestSource(hitTestOptions[0])
                                                .then(hitTestSource => {
                                                    logDebug("Hit test source creado correctamente");
                                                    hitTestStartTime = performance.now();
                                                    setupHitTesting(session, hitTestSource, refSpace);
                                                })
                                                .catch(error => {
                                                    logDebug(`Error al solicitar hit test source: ${error.message}`, true);
                                                    
                                                    // Try alternative hit test types if first fails
                                                    for (let i = 1; i < hitTestOptions.length; i++) {
                                                        try {
                                                            session.requestHitTestSource(hitTestOptions[i])
                                                                .then(hitTestSource => {
                                                                    logDebug(`Método alternativo ${i} de hit test funcionando`);
                                                                    hitTestStartTime = performance.now();
                                                                    setupHitTesting(session, hitTestSource, refSpace);
                                                                })
                                                                .catch(e => {
                                                                    logDebug(`Método alternativo ${i} falló: ${e.message}`, true);
                                                                    
                                                                    // If last method, switch to manual placement
                                                                    if (i === hitTestOptions.length - 1) {
                                                                        setupManualPlacement();
                                                                    }
                                                                });
                                                        } catch (e) {
                                                            logDebug(`Error al intentar método ${i}: ${e.message}`, true);
                                                        }
                                                    }
                                                });
                                        })
                                        .catch(error => {
                                            logDebug(`Error al solicitar reference space: ${error.message}`, true);
                                            setupManualPlacement();
                                        });
                                })
                                .catch(error => {
                                    logDebug(`Error al solicitar sesión AR: ${error.message}`, true);
                                    showFallbackModel('Error al iniciar AR');
                                });
                        })
                        .catch(error => {
                            logDebug(`Error al verificar soporte AR: ${error.message}`, true);
                            showFallbackModel('Error verificando soporte AR');
                        });
                } else {
                    logDebug("WebXR API no disponible en este navegador", true);
                    showFallbackModel('WebXR no disponible');
                }
            }
            
            // Set up manual placement mode
            function setupManualPlacement() {
                if (usingFallbackPlacement || !xrSession) return;
                
                usingFallbackPlacement = true;
                logDebug("Cambiando a modo de colocación manual", true);
                statusMessage.textContent = "Toca el botón para colocar el modelo";
                
                // Show action button
                actionButton.classList.remove('hidden');
                actionButton.addEventListener('click', () => {
                    placeModelManually();
                });
            }
            
            // Place model manually (without hit test)
            function placeModelManually() {
                if (!xrSession) return;
                
                logDebug("Colocando modelo manualmente (sin hit test)");
                
                // Use viewer pose to place in front
                xrSession.requestAnimationFrame((time, frame) => {
                    const viewerPose = frame.getViewerPose(frame.session.renderState.baseReferenceSpace);
                    if (viewerPose) {
                        const position = viewerPose.transform.position;
                        const orientation = viewerPose.transform.orientation;
                        
                        // Calculate position 2 meters in front of user
                        const forward = new THREE.Vector3(0, 0, -2);
                        const quaternion = new THREE.Quaternion(
                            orientation.x, orientation.y, orientation.z, orientation.w
                        );
                        forward.applyQuaternion(quaternion);
                        
                        const finalPosition = {
                            x: position.x + forward.x,
                            y: position.y - 0.5, // Place slightly below eye level
                            z: position.z + forward.z
                        };
                        
                        logDebug(`Colocando en: x=${finalPosition.x.toFixed(2)}, y=${finalPosition.y.toFixed(2)}, z=${finalPosition.z.toFixed(2)}`);
                        
                        // Position the model
                        standModel.setAttribute('position', finalPosition);
                        standModel.setAttribute('visible', true);
                        
                        // Update UI
                        statusMessage.textContent = 'Toca el modelo para Instagram';
                        actionButton.classList.add('hidden');
                        
                        // Add click listener
                        standModel.addEventListener('click', openInstagram);
                    } else {
                        logDebug("No se pudo obtener viewer pose", true);
                        showFallbackModel("Error colocando modelo");
                    }
                });
            }
            
            // Handle session end
            function onSessionEnd() {
                logDebug("Sesión AR finalizada");
                xrSession = null;
                usingFallbackPlacement = false;
                startScreen.classList.remove('hidden');
                arScene.style.display = 'none';
                statusMessage.classList.add('hidden');
                debugPanel.classList.add('hidden');
                actionButton.classList.add('hidden');
                standModel.setAttribute('visible', false);
            }
            
            // Set up hit testing
            function setupHitTesting(session, hitTestSource, refSpace) {
                let modelPlaced = false;
                let noHitCount = 0;
                let maxNoHitBeforeWarning = 90; // About 1.5 seconds
                
                function onFrame(time, frame) {
                    frameCount++;
                    
                    if (!session) {
                        logDebug("Sesión no disponible en frame", true);
                        return;
                    }
                    
                    if (modelPlaced) {
                        return;
                    }
                    
                    session.requestAnimationFrame(onFrame);
                    
                    // Every 30 frames (about 0.5 seconds) log diagnostics
                    if (frameCount % 30 === 0) {
                        const elapsedTime = Math.floor((performance.now() - hitTestStartTime) / 1000);
                        logDebug(`Búsqueda de superficies: ${elapsedTime}s, Hits: ${hitTestCount}`);
                    }
                    
                    // After 15 seconds with no hits, switch to manual
                    if (frameCount > 900 && hitTestCount === 0 && !usingFallbackPlacement) {
                        setupManualPlacement();
                    }
                    
                    try {
                        const hitTestResults = frame.getHitTestResults(hitTestSource);
                        
                        if (hitTestResults.length > 0) {
                            lastHitTestTime = performance.now();
                            hitTestCount++;
                            noHitCount = 0;
                            
                            if (hitTestCount === 1) {
                                logDebug("Primera superficie detectada!");
                            }
                            
                            // Log hits at regular intervals
                            if (hitTestCount % 30 === 0) {
                                const pose = hitTestResults[0].getPose(refSpace);
                                if (pose) {
                                    const {x, y, z} = pose.transform.position;
                                    logDebug(`Posición superficie: x=${x.toFixed(2)}, y=${y.toFixed(2)}, z=${z.toFixed(2)}`);
                                }
                            }
                            
                            statusMessage.textContent = 'Superficie detectada - Toca para colocar';
                            
                            // Add tap listener if not already added
                            if (!modelPlaced) {
                                session.addEventListener('select', () => {
                                    logDebug("Evento select recibido, colocando modelo");
                                    
                                    const hit = frame.getHitTestResults(hitTestSource)[0];
                                    if (hit) {
                                        const pose = hit.getPose(refSpace);
                                        if (pose) {
                                            // Position model at hit point
                                            const {x, y, z} = pose.transform.position;
                                            logDebug(`Colocando modelo en: x=${x.toFixed(2)}, y=${y.toFixed(2)}, z=${z.toFixed(2)}`);
                                            
                                            standModel.setAttribute('position', `${x} ${y} ${z}`);
                                            standModel.setAttribute('visible', true);
                                            
                                            // Update UI
                                            statusMessage.textContent = 'Toca el modelo para Instagram';
                                            modelPlaced = true;
                                            
                                            // Add model click listener
                                            standModel.addEventListener('click', openInstagram);
                                            logDebug("Modelo colocado correctamente");
                                        } else {
                                            logDebug("No se pudo obtener pose válida", true);
                                        }
                                    } else {
                                        logDebug("No se encontró hit test result en evento select", true);
                                    }
                                }, {once: true});
                            }
                        } else {
                            noHitCount++;
                            
                            // If we haven't found surfaces for a while, provide more feedback
                            if (noHitCount === maxNoHitBeforeWarning) {
                                logDebug("No se están detectando superficies. Intenta:", true);
                                logDebug("1. Mueve el dispositivo lentamente", true);
                                logDebug("2. Asegúrate de tener buena iluminación", true);
                                logDebug("3. Apunta a superficies planas como pisos o mesas", true);
                                
                                statusMessage.textContent = 'Mueve lentamente para detectar superficies';
                            }
                            
                            if (frameCount > 300 && hitTestCount === 0) {
                                // After 5 seconds with no hits, show a more detailed message
                                statusMessage.textContent = 'Dificultad detectando superficies. Mueve lentamente.';
                            }
                        }
                    } catch (err) {
                        logDebug(`Error en frame AR: ${err.message}`, true);
                    }
                }
                
                try {
                    session.requestAnimationFrame(onFrame);
                } catch (err) {
                    logDebug(`Error al iniciar animation frame: ${err.message}`, true);
                    showFallbackModel('Error en loop de renderizado');
                }
            }
            
            // Show model in fallback mode
            function showFallbackModel(message) {
                statusMessage.textContent = message;
                logDebug(`Activando modo fallback: ${message}`, true);
                standModel.setAttribute('position', '0 0 -3');
                standModel.setAttribute('visible', true);
                standModel.addEventListener('click', openInstagram);
                
                // After 3 seconds, hide the error message
                setTimeout(() => {
                    statusMessage.textContent = 'Toca el modelo para visitar Instagram';
                }, 3000);
            }
            
            // Open Instagram
            function openInstagram() {
                logDebug("Abriendo Instagram");
                window.open('https://www.instagram.com/coparmex_cdmx', '_blank');
            }
            
            // Check if model loaded successfully
            standModel.addEventListener('model-loaded', () => {
                logDebug("Modelo 3D cargado correctamente");
            });
            
            standModel.addEventListener('model-error', (e) => {
                logDebug(`Error al cargar modelo 3D: ${e.detail.message || 'Error desconocido'}`, true);
            });
            
            // Set up event listeners
            startButton.addEventListener('click', startAR);
            startButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                startAR();
            });
        });
    </script>
</body>
</html> 